<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            （源码解读）深入理解小虫策略-1 | 
        
        ayuLiao
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="ayuLiao">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",python">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ayuLiao">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://lmwen.top">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="（源码解读）深入理解小虫策略-1 | ayuLiao">
    <meta property="og:image" content="/img/favicon.png" />
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="python"> 

    
        <meta property="article:published_time" content="Sat Dec 30 2017 11:54:35 GMT+0800" />
        <meta property="article:modified_time" content="Sat Dec 30 2017 12:05:00 GMT+0800" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="（源码解读）深入理解小虫策略-1 | ayuLiao">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://lmwen.top" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://lmwen.top/2017/12/30/（源码解读）深入理解小虫策略-1/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "ayuLiao",
        "logo": "/img/favicon.png"
    },
    "author": {
        "@type": "Person",
        "name": "ayuLiao",
        "image": {
            "@type": "ImageObject",
            "url": "/img/favicon.png"
        },
        "description": "过往不恋，未来不惧，当下不乱"
    },
    "headline": "（源码解读）深入理解小虫策略-1",
    "url": "http://lmwen.top/2017/12/30/（源码解读）深入理解小虫策略-1/index.html",
    "datePublished": "Sat Dec 30 2017 11:54:35 GMT+0800",
    "dateModified": "Sat Dec 30 2017 12:05:00 GMT+0800",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://lmwen.top"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    
    
    .footer-sns-gplus {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHpNNDMwIDI5NS40YzQwLjYgMTUuNCA1Ni42IDIzLjggNzIuNiAzOC40IDYuOCA2LjIgNy4yIDE1LjIgMSAyMy40LTYuMiA4LTMzLjYgMzMuOC0zOSAzNi42LTUuNiAyLjgtMTcuNiAyLjgtMjMuMi0uMi0yLjQtMS4yLTguMi01LjItMTMtOC44LTExLjItOC42LTI0LjYtMTEuMi01NS4yLTExLjItMjcuNCAwLTQwLjYgMi42LTUyLjIgMTAuNC00LjQgMi44LTEyLjIgNy42LTE3LjIgMTAuNi0yMyAxMy4yLTUxLjQgNTUtNTUuOCA4Mi40LTIuNiAxNS42LTIuNCAzNC44LjIgNTEgMi44IDE3LjQgMTkuOCA0OC44IDM1LjIgNjUuMiAxNiAxNi42IDQ1IDMzLjYgNjIuOCAzNi42IDI2LjggNC40IDY1LjggMS42IDc5LjQtNS44IDIwLjYtMTEuNCAzMS0xOSA0MS0zMC40IDE4LjgtMjEuNiAyMy40LTM0LjIgMTUuNi00My44LTMuOC00LjgtNC40LTQuOC01MS01LjgtNjAuOC0xLjItNTYuMiAyLjItNTYuMi00My4yIDAtMzIuNC4yLTMzLjIgNC44LTM3IDQuNC0zLjYgOS0zLjggOTItMy44IDc5IDAgODcuOC40IDk0LjIgMy42IDExLjIgNS42IDEzIDExLjQgMTIuOCA0My40IDAgMjUuNC0uOCAzMC44LTcuNiA1OC00IDE2LjYtOS44IDM0LTEyLjYgMzktMi44IDUtOC4yIDE0LjItMTEuNiAyMC42LTguNCAxNS40LTI3LjIgMzYuOC00MC44IDQ2LjYtNS44IDQuNC0xMy44IDEwLjItMTcuNiAxMy4yLTMuOCAzLTExIDctMTYuMiA4LjgtNS4yIDEuOC0xNi4yIDYuNC0yNC40IDEwLTIyLjQgOS42LTM0LjggMTEuNi03MyAxMS42LTM3LjYuMi00Ny0xLjQtNzEtMTItOC4yLTMuNi0xNy42LTcuMi0yMC44LTgtMTUuOC0zLjgtNjctNDUuMi03Ny44LTYyLjgtMi4yLTMuOC03LjYtMTEuNi0xMS44LTE3LjItNC4yLTUuNC05LTE0LTEwLjYtMTktMS44LTQuOC02LjItMTYtMTAtMjQuOC0zLjYtOC44LTcuOC0yMi4yLTkuMi0yOS42LTMuMi0xOC44LTEuNC03OS40IDIuOC05MS40IDEzLjgtNDAuNiAzNS42LTc4IDU4LjgtMTAwLjIgMTQtMTMuNiA0Ny4yLTM2LjQgNTgtMzkuOCA0LjItMS40IDEzLjQtNS4yIDIwLjYtOC40IDIyLTEwIDMyLjgtMTEuNiA3Ni0xMSAzMy44LjYgNDAuNCAxLjIgNTAgNC44em0zNDAuOCA4MC44YzggMy42IDkuNiAxMS4yIDkuMiAzOS4yLS42IDM0LjQtLjYgMzQgNSAzOS42IDQuOCA1IDUuNCA1IDM3LjYgNSA0My40IDAgNDQuNC44IDQzLjIgMzYuMi0uOCAxNy0xLjIgMTguNC02LjQgMjMtNS40IDQuNi02LjYgNC44LTM3LjYgNC44LTMxLjIgMC0zMiAuMi0zNi44IDUtNS42IDUuNC01LjYgNC40LTUgNDEuMi40IDI2LjQuMiAyNy40LTQuNiAzMy00LjggNS42LTYgNS44LTI0LjQgNi40LTIwLjguOC0yOS42LTEuNC0zMy40LTguNC0xLjQtMi42LTItMTUuNi0xLjgtMzUuNi40LTMxLjIuNC0zMS42LTQuNi0zNi42cy01LjYtNS0zNi01Yy0xOC44IDAtMzMtLjgtMzYtMi4yLTcuNi0zLjYtOS42LTExLjItOC44LTMzLjguOC0yOC4yLjQtMjggNDEtMjggNDUuNCAwIDQ1LjQgMCA0NC42LTQyLjYtLjYtMzMtLjYtMzMgNS0zOC40IDQuNC00LjYgNi4yLTUgMjQuOC01IDExIDAgMjIuMiAxIDI1IDIuMnoiLz48L3N2Zz4=);
    }
    
    
    
    
    
    .footer-sns-github {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi40IDEuNC0yNi40IDE0LjItMzYgMjIuOC04IDcuMi0yMiAyOS44LTI0LjQgMzkuMi0xLjYgNi40LTIgMTEzLjItMS42IDM2OCAuNiAyOTkuNCAxIDM1OS44IDMuNCAzNjQgMTEgMjAuMiAyMS42IDMyLjQgMzcuMiA0MyAxNS42IDEwLjYgMTcuMiAxMS4yIDM0LjIgMTMuMiAxMC42IDEuMiA2My40IDEuNiAxMjcuNiAxLjRsMTA5LjYtLjYgNi02LjggNi4yLTYuOC0xLjItMjUuMmMtLjgtMTUuOC0uMi0zMy40IDEuNC00Ny4yIDMtMjUuNCAxLjQtMzYuMi02LTQzLjItNS00LjYtNi4yLTQuOC0zMC42LTQuMi0yNy42LjgtMjQgMS42LTY4LjgtMTYtOC42LTMuNC0yMi42LTE4LTI4LjQtMjkuOC0xMS40LTIyLjgtMjctNDUtMzkuMi01NS42LTE0LTEyLjItMTkuOC0yMC44LTE5LjgtMjguNiAwLTExLjYgMTMuNi0xMi42IDMzLjItMi40IDE2LjYgOC44IDIwLjggMTIuNCA0MC44IDM2LjIgMjQuMiAyOC42IDMxIDMzLjYgNTQgMzkuNiAxNS4yIDQgNDIuMiAzIDUxLjQtMS44IDktNC42IDE4LTE1LjIgMjQuNC0yOS4yIDExLjQtMjQuMiA3LjQtMzEuMi0yMC42LTM2LjgtOS44LTItMjkuMi04LTQzLjQtMTMuNC00MC40LTE1LjgtNjQuNi0zNy40LTg1LjQtNzYuMi0xMS42LTIxLjgtMTUuNC0zMy0xOC4yLTUzLjYtNC4yLTMyLjItNC44LTYwLjItMS40LTg0IDMuNC0yMy44IDYuOC0zMi44IDIwLjItNTQgNC02IDguOC0xNS42IDExLTIxLjQgMy44LTEwIDMuOC0xMS42IDEtMzAtNS4yLTM0LjItMy4yLTUyLjQgNy42LTcwLjIgNy4yLTEyLjIgMTUtMTcuMiAyNC4yLTE1LjggMTIuOCAyLjIgNTIgMTcuNCA2Ni44IDI2LjIgMjYgMTUgMjkgMTUuNCA4Mi40IDcuMiAyNC42LTMuOCAzMy44LTQuMiA2MC0zLjIgMTcgLjYgNDEuNCAzIDU0IDUuMiAzOC40IDYuNiA0OS42IDUuMiA3My0xMCA2LjYtNC4yIDE3LjQtOS40IDI0LTExLjYgNi42LTIuMiAxNi01LjggMjEtOC4yIDEzLTYgMjgtNS42IDM1LjYuOCAxMi40IDEwLjQgMTguNiA0MS40IDE0LjQgNzEuNi00LjQgMzAuNi0zIDM5LjQgOC40IDUzLjggMy40IDQuNCAxMS4yIDE5LjIgMTcuNCAzMy4yTDc3NSA0NDN2NzhsLTEwIDI4Yy0xNS4yIDQzLjItMzYuOCA3My4yLTY2LjIgOTIuOC0xMy40IDguOC01NyAyNS40LTc2LjggMjktMjguMiA1LjItMzMuMiAxMi42LTIyIDMyLjIgMTEuMiAxOS40IDEyLjQgMzIuOCAxMS42IDEyOS42bC0uNiA4NS44IDUuNCA0LjZjMy42IDMgOS4yIDUuMiAxNiA2IDUuOC44IDYwLjIgMSAxMjAuNi42IDEwOC40LS42IDExMC4yLS42IDExOS01IDI0LTExLjYgNDAtMjcuNCA1MS42LTUwLjZsNS40LTExIC42LTM0N2MuNC0yMjMtLjItMzUzLjQtMS40LTM2NS0yLTE3LTIuNi0xOC42LTEzLTM0LTEwLjYtMTUuNC0yMi44LTI2LjItNDMuMi0zNy4yLTQuMi0yLjQtNjQuNi0yLjgtMzY2LTMuMi0xOTguNiAwLTM2NCAuNC0zNjcuNiAxLjR6Ii8+PC9zdmc+);
    }
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?ezyEvm8ST5CGfpA+kFFi1g==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#简介"><span class="post-toc-number">1.</span> <span class="post-toc-text">简介</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#小虫策略的概念"><span class="post-toc-number">2.</span> <span class="post-toc-text">小虫策略的概念</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#规则的实例化"><span class="post-toc-number">3.</span> <span class="post-toc-text">规则的实例化</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#结尾"><span class="post-toc-number">4.</span> <span class="post-toc-text">结尾</span></a></li></ol>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        <!-- Custom Thumbnail -->
        <div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(http://onxxjmg4z.bkt.clouddn.com/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%B0%8F%E8%99%AB%E7%AD%96%E7%95%A5.jpg)">
    
            <p class="article-headline-p">
                （源码解读）深入理解小虫策略-1
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>ayuLiao</strong>
        <span>12月 30, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/python/">python</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=（源码解读）深入理解小虫策略-1&url=http://lmwen.top/2017/12/30/（源码解读）深入理解小虫策略-1/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=（源码解读）深入理解小虫策略-1&url=http://lmwen.top/2017/12/30/（源码解读）深入理解小虫策略-1/index.html&via=ayuLiao" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://lmwen.top/2017/12/30/（源码解读）深入理解小虫策略-1/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://lmwen.top/2017/12/30/（源码解读）深入理解小虫策略-1/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    
        <a class="post_share-link" href="https://www.linkedin.com/shareArticle?mini=true&url=http://lmwen.top/2017/12/30/（源码解读）深入理解小虫策略-1/index.html&title=（源码解读）深入理解小虫策略-1" target="_blank">
            <li class="mdl-menu__item">
                分享到 LinkedIn
            </li>
        </a>
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>分析对象来源：<a href="https://www.joinquant.com/post/6406?tag=algorithm" target="_blank" rel="external">面向对象策略框架升级版: 多因子选股+多因子权重排序示例策略</a></p>
<p>所谓小虫策略其实就是小虫实现的多因子小市值策略，策略已经在聚宽平台上开源，代码本身的策略逻辑其实并不复杂，正如小虫本人解释的</p>
<blockquote>
<p>经典二八择时<br>多财务因子选股票池+其它过滤股票池<br>对股票池多因子权重排序选择买股列表<br>固定周期调仓<br>固定买N只股，卖不在买股列表的股票</p>
</blockquote>
<p>但是代码结构非常值得学习，是种树状结构，通过具体的配置来获得相应的规则树，那么这个规则树其实就代表了具体的策略，本篇文章详细的聊聊</p>
<h2 id="小虫策略的概念"><a href="#小虫策略的概念" class="headerlink" title="小虫策略的概念"></a>小虫策略的概念</h2><p>小虫策略里有两个重要的概念，一个是Group组合器，另一个是Rule规则，Group用于组合多个策略，而Rule其实就是具体的规则，虽然两者的概念不同，但是在代码层面，它们其实是类似的，是基类Rule的多态实现，基类Rule大概在代码的436行</p>
<p><img src="http://obfs4iize.bkt.clouddn.com/xiaochong1.png" alt=""></p>
<p>那么它们多态的地方具体在哪？其实就在于其重写的handle_data()方法，可以看具体的代码，选择Group_rules作为要观察的组合器，Time_condition作为要观察的规则，两者主要区别代码片段如下</p>
<p><img src="http://obfs4iize.bkt.clouddn.com/xiaochong2.png" alt=""></p>
<p>从图中可以看出，Group_rules和Time_condition都继承了Rule这个基类并重写了基类中的部分方法，其中主要的差别就是两者的handle_data()方法，Group_rules组合器的handle_data()方法主要的作用就是调用该组合器中规则的handle_data()方法，简单讲就是调用下一层的handle_data()，而Time_condition规则的handle_data()方法就实现了一个具体的逻辑，这个逻辑就是Time_condition规则要做的事情，当然，两者在代码上还有其他差别，后面再仔细提</p>
<p>更直观的东西可以在来源网页中看到，这里再贴一下小虫策略的整个结构图</p>
<p><img src="https://image.joinquant.com/74133e9d666a32b3e4a9ee83a7ba656d" alt=""></p>
<h2 id="规则的实例化"><a href="#规则的实例化" class="headerlink" title="规则的实例化"></a>规则的实例化</h2><p>因为小虫策略是依托在聚宽平台上的，所以一开始会知道的方法应该是initialize()方法，这是聚宽平台规定的，那么就先来看initialize()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def initialize(context):</div><div class="line">    # 策略配置</div><div class="line">    select_strategy(context)</div><div class="line">    # 创建策略组合--&gt;g.main其实就是Strategy_Group类的实例了，所以其中有很多内容</div><div class="line">    # Strategy_Group策略组合器</div><div class="line">    # 初始化时使用了Strategy_Group父类Group_rules的__init__方法，进行了初始化</div><div class="line">    g.main = Strategy_Group(&#123;&apos;config&apos;: g.main_config</div><div class="line">                                , &apos;g_class&apos;: Global_variable</div><div class="line">                                , &apos;memo&apos;: g.strategy_memo</div><div class="line">                                , &apos;name&apos;: &apos;_main_&apos;&#125;)</div><div class="line">    # 调用了Strategy_Group的initialize方法</div><div class="line">    g.main.initialize(context)</div><div class="line"></div><div class="line">    # 打印规则参数</div><div class="line">    # 所有策略的组合的顺序,递归显示</div><div class="line">    g.main.log.info(g.main.show_strategy())</div></pre></td></tr></table></figure>
<p>在该方法中，一开始就调用了select_strategy()方法，将聚宽特定的变量context传入<a href="https://www.joinquant.com/api#context" target="_blank" rel="external">聚宽context</a>，select_strategy()方法的主要作用就是配置规则，应该不同的策略会使用不同的规则，那么就可以在该方法中进行配置，配置完后，就会获得由多个组合器组合成的set，名为g.main_config，</p>
<p>接着通过获得的配置和其他参数实例化Strategy_Group类，这个类是一个组合器，也就是可以直观的理解为将前面获得的多个组合器组合在一起成为一个大的组合器（组合器是可以相互嵌套的）</p>
<p>接着使用Strategy_Group类的initialize()方法初始化一下，最后就是打印出所有规则的参数</p>
<p>那么select_strategy()方法中到底如何配置规则？Strategy_Group类中究竟可以做什么？</p>
<p>首先解决第一个问题，select_strategy()方法中到底如何配置规则？直接看到select_strategy()方法中的部分代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&apos;&apos;&apos; ---------------------配置 调仓条件判断规则-----------------------&apos;&apos;&apos;</div><div class="line">    # 调仓条件判断</div><div class="line">    adjust_condition_config = [</div><div class="line">        [True, &apos;_time_c_&apos;, &apos;调仓时间&apos;, Time_condition, &#123;</div><div class="line">            &apos;times&apos;: [[14, 50]],  # 调仓时间列表，二维数组，可指定多个时间点</div><div class="line">        &#125;],</div><div class="line">        [True, &apos;_Stop_loss_by_price_&apos;, &apos;指数最高低价比值止损器&apos;, Stop_loss_by_price, &#123;</div><div class="line">            &apos;index&apos;: &apos;000001.XSHG&apos;,  # 使用的指数,默认 &apos;000001.XSHG&apos;</div><div class="line">            &apos;day_count&apos;: 160,  # 可选 取day_count天内的最高价，最低价。默认160</div><div class="line">            &apos;multiple&apos;: 2.2  # 可选 最高价为最低价的multiple倍时，触 发清仓</div><div class="line">        &#125;],</div><div class="line">        [True, &apos;&apos;, &apos;多指数20日涨幅止损器&apos;, Mul_index_stop_loss, &#123;</div><div class="line">            &apos;indexs&apos;: [index2, index8],</div><div class="line">            &apos;min_rate&apos;: 0.005</div><div class="line">        &#125;],</div><div class="line">        [True, &apos;&apos;, &apos;调仓日计数器&apos;, Period_condition, &#123;</div><div class="line">            &apos;period&apos;: 3,  # 调仓频率,日</div><div class="line">        &#125;],</div><div class="line">    ]</div><div class="line">    adjust_condition_config = [</div><div class="line">        [True, &apos;_adjust_condition_&apos;, &apos;调仓执行条件的判断规则组合&apos;, Group_rules, &#123;</div><div class="line">            &apos;config&apos;: adjust_condition_config</div><div class="line">        &#125;]</div><div class="line">    ]</div></pre></td></tr></table></figure>
<p>看起来比较复杂，其实不然，先看到第一个adjust_condition_config，其中有5个list，其实每个list都是一个规则的配置，比如第一个list是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[True, &apos;_time_c_&apos;, &apos;调仓时间&apos;, Time_condition, &#123;</div><div class="line">            &apos;times&apos;: [[14, 50]],  # 调仓时间列表，二维数组，可指定多个时间点</div><div class="line">        &#125;],</div></pre></td></tr></table></figure>
<p>True表示启用该规则，_time<em>c</em>是这个规则的<strong>唯一标识</strong>，要确保其唯一，’调仓时间’其实就是一个解释，Time_condition就是具体的规则，times就是Time_condition这个规则需要的参数，那么这整个list其实就是对Time_condition规则的配置，那么第一个adjust_condition_config中的其他list也一样，只是配置的具体参数有所不同</p>
<p>那么第二个adjust_condition_config，它只有一个list，其实这个list的规则跟前面的是一样的，True表示启用，_adjust<em>condition</em>是唯一的标识，’调仓执行条件的判断规则组合’是解释，Group_rules是配置的具体对象，config是Group_rules这个对象的参数，虽然写法上相同，但是Group_rules其实是个<strong>组合器</strong>，从这个配置中可以看出，它将前面的Time_condition、Stop_loss_by_price、Mul_index_stop_loss和Period_condition这4个规则都组合在一起，</p>
<p>那么整个select_strategy()方法其实形成了4个组合器，这4个组合器组合了多个不同的规则，最后我们将这4个组合器连接成一个set，赋值给g.main_config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">g.main_config = (common_config</div><div class="line">                     + adjust_condition_config</div><div class="line">                     + pick_new</div><div class="line">                     + adjust_position_config)</div></pre></td></tr></table></figure>
<p>然后再作为参数在实例化Strategy_Group类时使用</p>
<p>接着回答第二个问题，Strategy_Group类中究竟可以做什么？</p>
<p>看回到initialize()方法中，我们先实例化了Strategy_Group类，然后调用了Strategy_Group类的initialize()方法做了一些操作，接着调用了log.info()方法打印了一些内容，要明白这些代码做了什么，先要看一下Stategy_Group类的结构</p>
<p><img src="http://obfs4iize.bkt.clouddn.com/xiaochong3.png" alt=""></p>
<p>图中可以看出，Stategy_Group类继承自Group_rules类，Group_rules类最终又继承与Rule这个基类</p>
<p>仔细看Strategy_Group类的结构可以发现它本身是没有实现<strong>init</strong>()方法的，但是在实例化Strategy_Group类时又传入了参数，说明Strategy_Group类使用了Group_rules类中的<strong>init</strong>方法</p>
<p>所以要看到Group_rules类中的<strong>init</strong>()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">class Group_rules(Rule):</div><div class="line">    rules = []</div><div class="line">    # 规则配置list下标描述变量。提高可读性与未来添加更多规则配置。</div><div class="line">    cs_enabled, cs_name, cs_memo, cs_class_type, cs_param = range(5)</div><div class="line"></div><div class="line">    def __init__(self, params):</div><div class="line">        Rule.__init__(self, params)</div><div class="line">        self.config = params.get(&apos;config&apos;, [])</div><div class="line">        pass</div><div class="line"></div><div class="line">    def update_params(self, context, params):</div><div class="line">        Rule.update_params(self, context, params)</div><div class="line">        self.config = params.get(&apos;config&apos;, self.config)</div><div class="line"></div><div class="line">    def initialize(self, context):</div><div class="line">        # 创建规则</div><div class="line">        self.rules = self.create_rules(self.config)</div><div class="line">        for rule in self.rules:</div><div class="line">            rule.initialize(context)</div><div class="line">        pass</div><div class="line"></div><div class="line">    def handle_data(self, context, data):</div><div class="line">        for rule in self.rules:</div><div class="line">            # 调用下一层的handle_data</div><div class="line">            rule.handle_data(context, data)</div><div class="line">            if rule.to_return:</div><div class="line">                self.is_to_return = True</div><div class="line">                return</div><div class="line">        self.is_to_return = False</div><div class="line">        pass</div></pre></td></tr></table></figure>
<p>从图中可以看出，Group_rules类的<strong>init</strong>()方法很简单，显示调用了父类，也就是Rule的<strong>init</strong>()方法，然后再从传入的参数中通过config这个key来获得g.main_config，那么此时就获得了实例化Strategy_Group类时传入的参数</p>
<p>接着我们调用了Strategy_Group类的initialize方法，直接看到代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"># 策略组合器</div><div class="line"># 继承Group_rules</div><div class="line">class Strategy_Group(Group_rules):</div><div class="line">    def initialize(self, context):</div><div class="line">        self.g = self._params.get(&apos;g_class&apos;, Global_variable)(self)</div><div class="line">        self.memo = self._params.get(&apos;memo&apos;, self.memo)</div><div class="line">        self.name = self._params.get(&apos;name&apos;, self.name)</div><div class="line">        self.log = g.log_type(self.memo)</div><div class="line">        self.g.context = context</div><div class="line">        # 调用父类的initialize，对配置文件中配置的规则进行实例化</div><div class="line">        Group_rules.initialize(self, context)</div><div class="line"></div><div class="line">    def handle_data_level(self, context, data, level):</div><div class="line">        for rule in self.rules:</div><div class="line">            if rule.level != level:</div><div class="line">                continue</div><div class="line">            rule.handle_data(context, data)</div><div class="line">            if rule.to_return and not isinstance(rule, Strategy_Group):  # 这里新增控制，假如是其它策略组合器要求退出的话，不退出。</div><div class="line">                self.is_to_return = True</div><div class="line">                return</div><div class="line">        self.is_to_return = False</div><div class="line">        pass</div><div class="line"></div><div class="line">    def handle_data(self, context, data):</div><div class="line">        self.handle_data_level(context, data, Rule_Level.Prior)</div><div class="line">        self.handle_data_level(context, data, Rule_Level.Normal)</div><div class="line">        self.handle_data_level(context, data, Rule_Level.Finally)</div><div class="line"></div><div class="line">    # 重载 set_g函数,self.g不再被外部修改</div><div class="line">    def set_g(self, g):</div><div class="line">        if self.g is None:</div><div class="line">            self.g = g</div></pre></td></tr></table></figure>
<p>Strategy_Group类的initialize()方法先实例化了Global_variable类，然后再获得其他参数的值，接着调用了父类Group_rules的initialize()方法</p>
<p>Group_rules的initialize()方法可以看到上面的代码，它的主要作用就是创建规则的实例，也就是实例化最前面配置的规则，其中使用了create_rules()方法，这个方法也在Group_rules类中，看一下它的具体代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># 创建一个规则执行器，并初始化一些通用事件</div><div class="line">def create_rule(self, class_type, params, name, memo):</div><div class="line">    obj = class_type(params)</div><div class="line">    # obj.g = self.g</div><div class="line">    obj.set_g(self.g)</div><div class="line">    obj.name = name</div><div class="line">    obj.memo = memo</div><div class="line">    obj.log = g.log_type(obj.memo)</div><div class="line">    # print g.log_type,obj.memo</div><div class="line">    return obj</div><div class="line"></div><div class="line"># 根据规则配置创建规则执行器</div><div class="line">def create_rules(self, config):</div><div class="line">    # config里 0.是否启用，1.描述，2.规则实现类名，3.规则传递参数(dict)]</div><div class="line">    return [self.create_rule(c[self.cs_class_type], c[self.cs_param], c[self.cs_name], c[self.cs_memo]) for c in config if c[self.cs_enabled]]</div></pre></td></tr></table></figure>
<p>首先看create_rules()方法，在该方法中使用了列表生成式的方式来生成存放规则实例的list，其中通过for来循环配置，然后if判断这条规则是否启用，如果启用就通过create_rule()对它进行实例化，create_rule()方法就是规则具体实例化的地方，它有4个参数，class_type就是规则，params是这个规则的具体参数，name和memo就不提了，在python中万物介对象，所以一个规则类可以赋值给一个变量，然后通过这个变量来调用这个规则，完成实例化，那么obj = class_type(params)就是实例化了一个具体的规则或者组合器</p>
<p>弄明白了initialize()方法，接着来看聚宽的handle_data()方法，也就是最外面一层的handle_data()方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 按分钟回测</div><div class="line">def handle_data(context, data):</div><div class="line">    # 保存context到全局变量量，主要是为了方便规则器在一些没有context的参数的函数里使用。</div><div class="line">    g.main.g.context = context</div><div class="line">    # 执行策略</div><div class="line">    g.main.handle_data(context, data)</div></pre></td></tr></table></figure>
<p>其中逻辑非常简单，首先将聚宽提供的context变量放到g.main中（Strategy_Group类实例），这样做的目的其实是为了方便管理，然后执行了Strategy_Group中的handle_data方法，相关代码如下，上面的文章有完整的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">def handle_data_level(self, context, data, level):</div><div class="line">    for rule in self.rules:</div><div class="line">        if rule.level != level:</div><div class="line">            continue</div><div class="line">        rule.handle_data(context, data)</div><div class="line">        if rule.to_return and not isinstance(rule, Strategy_Group):  # 这里新增控制，假如是其它策略组合器要求退出的话，不退出。</div><div class="line">            self.is_to_return = True</div><div class="line">            return</div><div class="line">    self.is_to_return = False</div><div class="line">    pass</div><div class="line"></div><div class="line">def handle_data(self, context, data):</div><div class="line">    self.handle_data_level(context, data, Rule_Level.Prior)</div><div class="line">    self.handle_data_level(context, data, Rule_Level.Normal)</div><div class="line">    self.handle_data_level(context, data, Rule_Level.Finally)</div></pre></td></tr></table></figure>
<p>Strategy_Group类的handle_data()方法顺序执行了不同优先级的规则，先是Prior级然后是Normal级最后是Finally级，其实都通过handle_data_level实现具体的逻辑，handle_data_level()方法的逻辑比较简单，就是循环所有的规则实例，判断这个规则是否是这个优先级，如果是就执行该规则自己的handle_data，不是就跳过，其实在配置中我们没有定义规则的优先级，那么默认就是Normal级别</p>
<p>如果仔细读了代码，可以发现只有组合器才使用了create_rules()和create_rule()这两个方法，主要的作用就是实例化对象</p>
<p>现在来理一理实例化的过程，先来看到配置的整个结构，如图</p>
<p><img src="http://obfs4iize.bkt.clouddn.com/xiaochong4.png" alt=""></p>
<p>从图可以直观的看出，它是一个树状结构，g.main_config是根，最后具体的规则是叶子节点，那么一开始create_rules()循环的对象是g.main_config，直白将就是遍历了common_config、adjust_condition_config、pick_new和adjust_position这4个组合器，然后通过create_rule()方法将这些组合器实例化，这是第一轮循环，可以发现实例化的都是组合器，实例化后接着就是调用下一层的initialize()方法，也就是调用common_config、adjust_condition_config、pick_new和adjust_position这4个组合器的initialize()方法，具体代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">def initialize(self, context):</div><div class="line">    # 创建规则</div><div class="line">    self.rules = self.create_rules(self.config)</div><div class="line">    for rule in self.rules:</div><div class="line">        rule.initialize(context)</div><div class="line">    pass</div></pre></td></tr></table></figure>
<p>从树状图中可以看出common_config、adjust_condition_config、pick_new和adjust_position这4个组合器其实都继承了Group_rules这个类，虽然pick_new和adjust_position_config不是直接继承，但是依旧来自Group_rules，而且Pick_stocks和Adjust_position没有重写父类的initialize()方法，那么讲来将去，上面的代码其实还是使用Group_rules类中的initialize()方法进行实例化，同样使用create_rules()方法，这就是第二轮循环，接着同样的流程进行第三轮循环，比如对adjust_condition_config进行第三轮循环，也就是循环Time_condition、Stop_loss_by_price、Mul_index_stop_loss和Period_condition这四个规则，可以发现<strong>它们都是规则了，而不是组合器，而单纯的规则是没有实例化对象的代码的</strong>，这也是规则和组合器的一个明显差别，也就是规则是不可以包含规则的，不然无法实例化这个规则，从图中可以看出，以Time_condition这个规则和Group_rules这个组合器进行比较，除了前面提及的两者handle_data()方法中逻辑不通，还有就是initialize()方法也明显不通，在组合器里，initialize()方法中会调用create_rules()方法对组合器里的对象进实例化，如果组合器里嵌套了组合器，那么就会一层层实例化下去</p>
<p><img src="http://obfs4iize.bkt.clouddn.com/xiaochong6.png" alt=""></p>
<p><strong>通过上面的逐层实例化后，就可以获得配置中所有对象的一个实例，接着就可以使用这些实例了，使用的方式其实跟上面的方式类似，逐层调用每个实例的handle_data()方法，只是组合器对应的实例其handle_data()方法中的逻辑是调用组合器中其他实例的handle_data，而规则对应的实例其handle_data()方法一般就用于实现该规则具体的逻辑，如何时买卖股票等等</strong></p>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>篇幅过长，其他内容写到第二篇中</p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/12/30/我的2017/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/12/30/Centos7-Nginx部署Django/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="ayuLiao's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        myemailliao@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="myemailliao@gmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/06/">六月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/05/">五月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/04/">四月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/03/">三月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">二月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/tags" title="标签">
                
                    <i class="material-icons sidebar-material-icons">label</i>
                
                标签
            </a>
        </li>
        
    
        <li>
            <a href="/timeline" title="时间轴">
                
                    <i class="material-icons sidebar-material-icons">timeline</i>
                
                时间轴
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://www.github.com/ayuliao" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;2016&nbsp;-<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>ayuLiao
            <div>
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <div>
        本站总访问量 <span id="busuanzi_value_site_pv"></span> &nbsp&nbsp&nbsp
        你是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴
        </div>
        </div>
        </div>

        <!-- Paradox Footer Right Section -->

        

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?wgjW/HuQG9JDgvPDPoRAng==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script>lsloader.load("js/smoothscroll.js","/js/smoothscroll.js?tNQK2Tw2SUL8a1Scn/Mgew==")</script>
    











<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
        </body>
    
</html>
