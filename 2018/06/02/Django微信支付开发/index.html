<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            Django微信支付开发 | 
        
        ayuLiao
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="ayuLiao">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",python">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ayuLiao">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://lmwen.top">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Django微信支付开发 | ayuLiao">
    <meta property="og:image" content="/img/favicon.png" />
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="python"> 

    
        <meta property="article:published_time" content="Sat Jun 02 2018 21:13:15 GMT+0800" />
        <meta property="article:modified_time" content="Sat Jul 07 2018 21:29:50 GMT+0800" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="Django微信支付开发 | ayuLiao">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://lmwen.top" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://lmwen.top/2018/06/02/Django微信支付开发/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "ayuLiao",
        "logo": "/img/favicon.png"
    },
    "author": {
        "@type": "Person",
        "name": "ayuLiao",
        "image": {
            "@type": "ImageObject",
            "url": "/img/favicon.png"
        },
        "description": "过往不恋，未来不惧，当下不乱"
    },
    "headline": "Django微信支付开发",
    "url": "http://lmwen.top/2018/06/02/Django微信支付开发/index.html",
    "datePublished": "Sat Jun 02 2018 21:13:15 GMT+0800",
    "dateModified": "Sat Jul 07 2018 21:29:50 GMT+0800",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://lmwen.top"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    
    
    .footer-sns-gplus {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHpNNDMwIDI5NS40YzQwLjYgMTUuNCA1Ni42IDIzLjggNzIuNiAzOC40IDYuOCA2LjIgNy4yIDE1LjIgMSAyMy40LTYuMiA4LTMzLjYgMzMuOC0zOSAzNi42LTUuNiAyLjgtMTcuNiAyLjgtMjMuMi0uMi0yLjQtMS4yLTguMi01LjItMTMtOC44LTExLjItOC42LTI0LjYtMTEuMi01NS4yLTExLjItMjcuNCAwLTQwLjYgMi42LTUyLjIgMTAuNC00LjQgMi44LTEyLjIgNy42LTE3LjIgMTAuNi0yMyAxMy4yLTUxLjQgNTUtNTUuOCA4Mi40LTIuNiAxNS42LTIuNCAzNC44LjIgNTEgMi44IDE3LjQgMTkuOCA0OC44IDM1LjIgNjUuMiAxNiAxNi42IDQ1IDMzLjYgNjIuOCAzNi42IDI2LjggNC40IDY1LjggMS42IDc5LjQtNS44IDIwLjYtMTEuNCAzMS0xOSA0MS0zMC40IDE4LjgtMjEuNiAyMy40LTM0LjIgMTUuNi00My44LTMuOC00LjgtNC40LTQuOC01MS01LjgtNjAuOC0xLjItNTYuMiAyLjItNTYuMi00My4yIDAtMzIuNC4yLTMzLjIgNC44LTM3IDQuNC0zLjYgOS0zLjggOTItMy44IDc5IDAgODcuOC40IDk0LjIgMy42IDExLjIgNS42IDEzIDExLjQgMTIuOCA0My40IDAgMjUuNC0uOCAzMC44LTcuNiA1OC00IDE2LjYtOS44IDM0LTEyLjYgMzktMi44IDUtOC4yIDE0LjItMTEuNiAyMC42LTguNCAxNS40LTI3LjIgMzYuOC00MC44IDQ2LjYtNS44IDQuNC0xMy44IDEwLjItMTcuNiAxMy4yLTMuOCAzLTExIDctMTYuMiA4LjgtNS4yIDEuOC0xNi4yIDYuNC0yNC40IDEwLTIyLjQgOS42LTM0LjggMTEuNi03MyAxMS42LTM3LjYuMi00Ny0xLjQtNzEtMTItOC4yLTMuNi0xNy42LTcuMi0yMC44LTgtMTUuOC0zLjgtNjctNDUuMi03Ny44LTYyLjgtMi4yLTMuOC03LjYtMTEuNi0xMS44LTE3LjItNC4yLTUuNC05LTE0LTEwLjYtMTktMS44LTQuOC02LjItMTYtMTAtMjQuOC0zLjYtOC44LTcuOC0yMi4yLTkuMi0yOS42LTMuMi0xOC44LTEuNC03OS40IDIuOC05MS40IDEzLjgtNDAuNiAzNS42LTc4IDU4LjgtMTAwLjIgMTQtMTMuNiA0Ny4yLTM2LjQgNTgtMzkuOCA0LjItMS40IDEzLjQtNS4yIDIwLjYtOC40IDIyLTEwIDMyLjgtMTEuNiA3Ni0xMSAzMy44LjYgNDAuNCAxLjIgNTAgNC44em0zNDAuOCA4MC44YzggMy42IDkuNiAxMS4yIDkuMiAzOS4yLS42IDM0LjQtLjYgMzQgNSAzOS42IDQuOCA1IDUuNCA1IDM3LjYgNSA0My40IDAgNDQuNC44IDQzLjIgMzYuMi0uOCAxNy0xLjIgMTguNC02LjQgMjMtNS40IDQuNi02LjYgNC44LTM3LjYgNC44LTMxLjIgMC0zMiAuMi0zNi44IDUtNS42IDUuNC01LjYgNC40LTUgNDEuMi40IDI2LjQuMiAyNy40LTQuNiAzMy00LjggNS42LTYgNS44LTI0LjQgNi40LTIwLjguOC0yOS42LTEuNC0zMy40LTguNC0xLjQtMi42LTItMTUuNi0xLjgtMzUuNi40LTMxLjIuNC0zMS42LTQuNi0zNi42cy01LjYtNS0zNi01Yy0xOC44IDAtMzMtLjgtMzYtMi4yLTcuNi0zLjYtOS42LTExLjItOC44LTMzLjguOC0yOC4yLjQtMjggNDEtMjggNDUuNCAwIDQ1LjQgMCA0NC42LTQyLjYtLjYtMzMtLjYtMzMgNS0zOC40IDQuNC00LjYgNi4yLTUgMjQuOC01IDExIDAgMjIuMiAxIDI1IDIuMnoiLz48L3N2Zz4=);
    }
    
    
    
    
    
    .footer-sns-github {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi40IDEuNC0yNi40IDE0LjItMzYgMjIuOC04IDcuMi0yMiAyOS44LTI0LjQgMzkuMi0xLjYgNi40LTIgMTEzLjItMS42IDM2OCAuNiAyOTkuNCAxIDM1OS44IDMuNCAzNjQgMTEgMjAuMiAyMS42IDMyLjQgMzcuMiA0MyAxNS42IDEwLjYgMTcuMiAxMS4yIDM0LjIgMTMuMiAxMC42IDEuMiA2My40IDEuNiAxMjcuNiAxLjRsMTA5LjYtLjYgNi02LjggNi4yLTYuOC0xLjItMjUuMmMtLjgtMTUuOC0uMi0zMy40IDEuNC00Ny4yIDMtMjUuNCAxLjQtMzYuMi02LTQzLjItNS00LjYtNi4yLTQuOC0zMC42LTQuMi0yNy42LjgtMjQgMS42LTY4LjgtMTYtOC42LTMuNC0yMi42LTE4LTI4LjQtMjkuOC0xMS40LTIyLjgtMjctNDUtMzkuMi01NS42LTE0LTEyLjItMTkuOC0yMC44LTE5LjgtMjguNiAwLTExLjYgMTMuNi0xMi42IDMzLjItMi40IDE2LjYgOC44IDIwLjggMTIuNCA0MC44IDM2LjIgMjQuMiAyOC42IDMxIDMzLjYgNTQgMzkuNiAxNS4yIDQgNDIuMiAzIDUxLjQtMS44IDktNC42IDE4LTE1LjIgMjQuNC0yOS4yIDExLjQtMjQuMiA3LjQtMzEuMi0yMC42LTM2LjgtOS44LTItMjkuMi04LTQzLjQtMTMuNC00MC40LTE1LjgtNjQuNi0zNy40LTg1LjQtNzYuMi0xMS42LTIxLjgtMTUuNC0zMy0xOC4yLTUzLjYtNC4yLTMyLjItNC44LTYwLjItMS40LTg0IDMuNC0yMy44IDYuOC0zMi44IDIwLjItNTQgNC02IDguOC0xNS42IDExLTIxLjQgMy44LTEwIDMuOC0xMS42IDEtMzAtNS4yLTM0LjItMy4yLTUyLjQgNy42LTcwLjIgNy4yLTEyLjIgMTUtMTcuMiAyNC4yLTE1LjggMTIuOCAyLjIgNTIgMTcuNCA2Ni44IDI2LjIgMjYgMTUgMjkgMTUuNCA4Mi40IDcuMiAyNC42LTMuOCAzMy44LTQuMiA2MC0zLjIgMTcgLjYgNDEuNCAzIDU0IDUuMiAzOC40IDYuNiA0OS42IDUuMiA3My0xMCA2LjYtNC4yIDE3LjQtOS40IDI0LTExLjYgNi42LTIuMiAxNi01LjggMjEtOC4yIDEzLTYgMjgtNS42IDM1LjYuOCAxMi40IDEwLjQgMTguNiA0MS40IDE0LjQgNzEuNi00LjQgMzAuNi0zIDM5LjQgOC40IDUzLjggMy40IDQuNCAxMS4yIDE5LjIgMTcuNCAzMy4yTDc3NSA0NDN2NzhsLTEwIDI4Yy0xNS4yIDQzLjItMzYuOCA3My4yLTY2LjIgOTIuOC0xMy40IDguOC01NyAyNS40LTc2LjggMjktMjguMiA1LjItMzMuMiAxMi42LTIyIDMyLjIgMTEuMiAxOS40IDEyLjQgMzIuOCAxMS42IDEyOS42bC0uNiA4NS44IDUuNCA0LjZjMy42IDMgOS4yIDUuMiAxNiA2IDUuOC44IDYwLjIgMSAxMjAuNi42IDEwOC40LS42IDExMC4yLS42IDExOS01IDI0LTExLjYgNDAtMjcuNCA1MS42LTUwLjZsNS40LTExIC42LTM0N2MuNC0yMjMtLjItMzUzLjQtMS40LTM2NS0yLTE3LTIuNi0xOC42LTEzLTM0LTEwLjYtMTUuNC0yMi44LTI2LjItNDMuMi0zNy4yLTQuMi0yLjQtNjQuNi0yLjgtMzY2LTMuMi0xOTguNiAwLTM2NCAuNC0zNjcuNiAxLjR6Ii8+PC9zdmc+);
    }
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?ezyEvm8ST5CGfpA+kFFi1g==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Django微信支付开发"><span class="post-toc-number">1.</span> <span class="post-toc-text">Django微信支付开发</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#简介"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">简介</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#微信支付流程"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">微信支付流程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#微信支付必要配置"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">微信支付必要配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#微信支付代码开发"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">微信支付代码开发</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#JSSDK授权"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">JSSDK授权</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#微信回调"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">微信回调</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#结尾"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">结尾</span></a></li></ol></li></ol>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        <!-- Custom Thumbnail -->
        <div class="post_thumbnail-custom mdl-card__media mdl-color-text--grey-50" style="background-image:url(http://obfs4iize.bkt.clouddn.com/django%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98.jpg)">
    
            <p class="article-headline-p">
                Django微信支付开发
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>ayuLiao</strong>
        <span>6月 02, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/python/">python</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Django微信支付开发&url=http://lmwen.top/2018/06/02/Django微信支付开发/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Django微信支付开发&url=http://lmwen.top/2018/06/02/Django微信支付开发/index.html&via=ayuLiao" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://lmwen.top/2018/06/02/Django微信支付开发/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://lmwen.top/2018/06/02/Django微信支付开发/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    
        <a class="post_share-link" href="https://www.linkedin.com/shareArticle?mini=true&url=http://lmwen.top/2018/06/02/Django微信支付开发/index.html&title=Django微信支付开发" target="_blank">
            <li class="mdl-menu__item">
                分享到 LinkedIn
            </li>
        </a>
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="Django微信支付开发"><a href="#Django微信支付开发" class="headerlink" title="Django微信支付开发"></a>Django微信支付开发</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>因为公司项目需要使用微信支付，所以就着手开发，一开始想着，文档微信给了，也很多人做了，应该很简单，是我太年轻了，深刻的体会到了微信支付文档对中华文化的巧妙运用，就是不跟你说明白，自己慢慢试，欲哭无泪，本篇文章简单整理了一下我的开发过程</p>
<p>微信支付有多种，我这里，使用的微信公众号支付，比如，公众号里开发了商城之类的运用需要支付都算是微信公众号支付</p>
<h2 id="微信支付流程"><a href="#微信支付流程" class="headerlink" title="微信支付流程"></a>微信支付流程</h2><p>虽然说很多人做过，网上也有很多代码可以让我们直接使用，但是不弄明白微信的支付流程，还是两眼黑的</p>
<p>直接上微信文档中的支付流程图，仔细看多几遍</p>
<p><img src="http://onxxjmg4z.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>从图中可以知道几个主要的步骤：</p>
<p>1.商户系统通过<strong>统一下单接口API</strong>请求微信支付系统，微信支付系统会<strong>返回预付订单信息，其中就包括prepay_id</strong>,prepay_id是非常重要的<br>2.通过prepay_id和其他关键信息做签名运算，将这些部分关键信息和签名运算后的结果返回（这里的说法比较暧昧，继续看下文就明白这些信息是什么？如何签名？）<br>3.前端获得这些关键信息后，就可以使用JSSDK将这些关键信息发送给微信支付系统，微信支付系统认证通过后，就会出现支付界面<br>4.支付成功后，微信支付系统会<strong>异步</strong>的返回用户支付结果通知，这里的通知前端后端都会获得，前端获得支付成功的通知可以做页面跳转操作，后端收到支付成功通知同样可以做一下操作</p>
<p>这里以商城为例，从一个实际的项目角度来看支付流程</p>
<p>1.前端会将用户购买商品的信息传递给后端，比如用户选购的商品ID，商品属性，商品单价等等，后端通过这些信息生成一个订单，订单的状态是待支付，然后返回生成订单成功的数据给前端</p>
<p>2.前端收到后端订单生成成功的信息后就跳转到支付界面，这个界面是前端实现的，在该界面中使用微信jssdk，通过jssdk来调用微信支付，前端使用jssdk前需要通过微信授权认证从而获得调用微信支付接口的权限</p>
<p>这一步要拆分成两个重要的步骤<br>a.前端要获得jssdk的权限，一般的做法是通过后端去调用微信的接口获得jssdk授权需要的配置信息，然后将这些配置信息返回给前端<br>b.前端通过后端返回的jssdk配置信息请求微信jssdk的授权接口，拿到jssdk的使用权限，只有拥有了使用权限才有资格去请求微信支付的接口<br>c.前端请求微信支付接口同样需要相应的信息，这些信息同样通过后端返回，后端此时就需要去请求微信的统一下单接口，获得统一下单接口返回的信息，通过这些信息进行签名，然后将签名信息和通过统一下单接口返回的信息都返回给前端<br>d.前端获得了后端返回的关于微信支付的信息后，就可以使用jssdk唤醒微信支付了，微信支付的付款界面和输入密码的界面完全不用我们管，jssdk已经帮我们实现好了</p>
<p>3.通过了步骤2，调用了微信支付后，用户付款成功、失败或者中途取消微信支付都会有个回调信息，这个信息是异步的，前端后端都会收到，前端收到就可以做一些支付后页面跳转的操作，而后端就做支付后的逻辑操作，比如将订单设置为支付成功，给用户安排发货的，因为这里是比较重要的逻辑，所以一定要验证回调接口的信息是不是微信支付系统返回的信息</p>
<p>上面就是大致的步骤，但是还有很多细节没有讲清楚，接着就通过代码来讲这些细节</p>
<h2 id="微信支付必要配置"><a href="#微信支付必要配置" class="headerlink" title="微信支付必要配置"></a>微信支付必要配置</h2><p>要调用微信支付，除了代码要写对之外，最重要的事情就是必要的配置必须配了，而且必须配置正确，不然调用微信支付就会错误，这里不得不吐槽一下，第一次调用微信支付失败应该是很正常的，那么失败的报错提醒应该是一个比较准确的信息，方便我们查错，但是微信就只告诉你，这里错了，为什么？有很多种原因，除了自己一个个试，没有啥办法，下面讲讲具体的配置</p>
<p>1.服务器可以与微信通信<br>这个在微信公众平台–&gt;开发–&gt;基本配置–&gt;服务器配置中设置，你需要在服务器端写好对应的响应接口，当你点击启用时，微信服务器会请求配置的url，你需要按微信的要求返回相应的数据，如果你返回了正确的数据，就会提示认证成功，此时服务器可以与微信服务器进行通信<br><img src="http://obfs4iize.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%981.png" alt=""></p>
<p>2.配置网页授权域名和JS接口安全域名<br>网页授权域名：只有授权域名下的网页才能通过微信正常访问，不会出现，非微信官方网页，要用户点击继续访问的界面，一般做微信公众号开发都要将开发的网站的域名进行授权，<strong>这里填写网站根域名则可，如www.lmwen.top</strong></p>
<p><img src="http://obfs4iize.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%982" alt=""></p>
<p>JS接口安全域名：只有JS接口安全域名才能调用微信提供的js，简单说就是只有这个域名下才能调用jssdk，当然要正常使用jssdk处理配置JS接口安全域名外还需要jssdk，<strong>这里填写调用jssdk网页的全域名，如www.lmwen.top/usejssdk.com/</strong>，如果前端是单页面开发，那么同样填写根域名则可</p>
<p>3.设置IP白名单<br>不是说通过了步骤1后，我们的服务器已经可以跟微信服务器通信了吗? 为什么要配置ip白名单呢？步骤1只是让你可以与微信服务器通信，但是要获得微信的access_token就需要配置ip白名单了，access_token是微信公众号开发的一个重要概念，需要搞清楚，而且微信不止一个access_token</p>
<p>4.配置支付授权目录<br>这个目录是JSAPI支付授权目录，也就是说，要使用JSSDK调用微信支付必须在授权目录下，这里需要注意的是，<strong>必须配置成最后一层，怎么说？比如你的支付目录是：www.lmwen.top/ayuliao/weipay/weipay.html，那么最后一层就是www.lmwen.top/ayuliao/weipay/</strong></p>
<h2 id="微信支付代码开发"><a href="#微信支付代码开发" class="headerlink" title="微信支付代码开发"></a>微信支付代码开发</h2><p>确保配置没问题了，就开始开发<br>先上一张我调用微信支付成功的图，让大家嗨一嗨</p>
<p><img src="http://obfs4iize.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%983.png" alt=""></p>
<p>下面就一步步来把坑踩了</p>
<h3 id="JSSDK授权"><a href="#JSSDK授权" class="headerlink" title="JSSDK授权"></a>JSSDK授权</h3><p>首先要看一遍微信的官方文档 <a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421141115" target="_blank" rel="external">微信JS-SDK说明文档</a></p>
<p>这里关注到步骤三，通过config接口注入权限验证配置，需要的信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">wx.config(&#123;</div><div class="line">    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</div><div class="line">    appId: &apos;&apos;, // 必填，公众号的唯一标识</div><div class="line">    timestamp: , // 必填，生成签名的时间戳</div><div class="line">    nonceStr: &apos;&apos;, // 必填，生成签名的随机串</div><div class="line">    signature: &apos;&apos;,// 必填，签名，见附录1</div><div class="line">    jsApiList: [] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>除了debug和jsApiList外，其他信息都需要后端返回，那么前端要做的就是通过Ajax请求后端提供的接口，向后端索要appId,timestamp,nonceStr,signature等信息</p>
<p>具体怎么做，其实微信JS-SDK说明文档中是有提的，但是坑爹的将它放到附录1，这么重要的东西你放附录，就是你爱用不用的态度，只能服气，具体的步骤如下：</p>
<p>1.获得access_token，如何获取access_token看这里<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421140183" target="_blank" rel="external">获取access_token</a></p>
<p>简单讲，就是通过你公众号的appid和secret向 <a href="https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET" target="_blank" rel="external">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</a> 发送GET请求，然后微信就会返回JSON类型的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;access_token&quot;:&quot;ACCESS_TOKEN&quot;,&quot;expires_in&quot;:7200&#125;</div></pre></td></tr></table></figure>
<p>access_token只会保存2小时且请求次数有限制，所以一般你需要将它保存到数据库中，每2小时请求一次该接口更新一下access_token，我一般1个半小时就更新一次，保证access_token是可以用的</p>
<p>具体代码如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def getAccessToken():</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    获得微信公众号的Access Token</div><div class="line">    每1个半小时调用一次，获得最新的Access Token</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    url = &quot;https://api.weixin.qq.com/cgi-bin/token&quot;</div><div class="line">    payload = &#123;&apos;grant_type&apos;: &apos;client_credential&apos;, &apos;appid&apos;: APPID,&apos;secret&apos;:APPSecret&#125;</div><div class="line">    r = requests.get(url, params=payload)</div><div class="line">    if r.status_code == requests.codes.ok:</div><div class="line">        return json.loads(r.text).get(&apos;access_token&apos;,&apos;&apos;)</div><div class="line">    return &apos;&apos;</div></pre></td></tr></table></figure>
<p>我在系统中开启了定时任务，每一个半小时就会调用一次getAccessToken()方法，并且将获得的最新的access_token存入mysql数据库总</p>
<p>2.通过access_token来获得jsapi_ticket<br>jsapi_ticket是公众号用于调用微信JS接口的临时票据，有效期同样是2个小时，因为jsapi_ticket调用次数也是有显示的，所以同样要将其存放到数据中，每2小时更新一次</p>
<p>其实就是通过access_token以GET方法请求 <a href="https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&amp;type=jsapi" target="_blank" rel="external">https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&amp;type=jsapi</a></p>
<p>成功会返回JSON格式数据，其中的ticket就是我们需要的jsapi_ticket：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">&quot;errcode&quot;:0,</div><div class="line">&quot;errmsg&quot;:&quot;ok&quot;,</div><div class="line">&quot;ticket&quot;:&quot;bxLdikRXVbTPdHSM05e5u5sUoXNKd8-41ZO3MhKoyN5OfkWITDGgnr2fwJ0m9E8NYzWKVZvdVtaUgWvsdshFKA&quot;,</div><div class="line">&quot;expires_in&quot;:7200</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看回到JSSDK授权的信息，似乎既没有要access_token也没有要jsapi_ticket，其实获得这两个值是为了通过微信规定的签名算法计算出jssdk授权时需要的signature</p>
<p>3.获得appId、timestamp、nonceStr和signature<br>先看下官方规定的签名规则：</p>
<blockquote>
<p>签名生成规则如下：参与签名的字段包括noncestr（随机字符串）, 有效的jsapi_ticket,timestamp（时间戳）, url（当前网页的URL，不包含#及其后面部分） 。对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式（即key1=value1&amp;key2=value2…）拼接成字符串string1。这里需要注意的是所有参数名均为小写字符。对string1作<strong>sha1加密</strong>，字段名和字段值都采用原始值，不进行URL 转义。</p>
</blockquote>
<p>为了快速开发，可以去网上找一下第三方的开源库，这里使用的是weixin-python，可以直接通过pip安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install weixin-python</div></pre></td></tr></table></figure>
<p>weixin-python中已经帮我们完成了微信登录、支付等常用功能的封装，并提供出相应的接口供我们使用，可以从Github上直接将这个项目拉下来</p>
<p><a href="https://github.com/zwczou/weixin-python" target="_blank" rel="external">weixin-python Github地址</a></p>
<p>你需要看一下文档，主动了解器参数代表的含义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">WEIXIN_TOKEN 必填，微信主动推送消息的TOKEN</div><div class="line">WEIXIN_SENDER 选填，微信发送消息的发送者</div><div class="line">WEIXIN_EXPIRES_IN 选填，微信推送消息的有效时间</div><div class="line">WEIXIN_MCH_ID 必填，微信商户ID，纯数字</div><div class="line">WEIXIN_MCH_KEY 必填，微信商户KEY</div><div class="line">WEIXIN_NOTIFY_URL 必填，微信回调地址</div><div class="line">WEIXIN_MCH_KEY_FILE 可选，如果需要用退款等需要证书的api，必选</div><div class="line">WEIXIN_MCH_CERT_FILE 可选</div><div class="line">WEIXIN_APP_ID 必填，微信公众号appid</div><div class="line">WEIXIN_APP_SECRET 必填，微信公众号appkey</div></pre></td></tr></table></figure>
<p>微信支付只需要</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">微信支付</div><div class="line"></div><div class="line">WEIXIN_APP_ID</div><div class="line">WEIXIN_MCH_ID</div><div class="line">WEIXIN_MCH_KEY</div><div class="line">WEIXIN_NOTIFY_URL</div><div class="line">WEIXIN_MCH_KEY_FILE</div><div class="line">WEIXIN_MCH_CERT_FILE</div></pre></td></tr></table></figure>
<p>简单看一下其中的源码，其实非常简单，这里分析一下，方便我们后面使用时不会懵逼</p>
<p>weixin-python有个主类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class Weixin(WeixinLogin, WeixinPay, WeixinMP, WeixinMsg):</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    微信SDK</div><div class="line"></div><div class="line">    :param app 如果非flask，传入字典配置，如果是flask直接传入app实例</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    def __init__(self, app=None):</div><div class="line">        if app is not None:</div><div class="line">            if isinstance(app, dict):</div><div class="line">                app = StandaloneApplication(config=app)</div><div class="line">            self.init_app(app)</div><div class="line">            self.app = app</div><div class="line">...</div></pre></td></tr></table></figure>
<p>它继承自WeixinLogin、WeixinPay、WeixinMP、WeixinMsg，也就是说Weixin这个类具有所有的功能，那么使用微信支付功能时，直接实例化这个类就好了，因为我们关注的是微信支付，所有重点关注一下WeixinPay类中的代码，这个类中帮我们实现了很多方法，使我们可以很方便的生成微信所需要的认证信息，但是，<strong>不要盲目使用</strong>，这些代码不是所有场景都能使用的，这个坑我已经踩了。</p>
<p>因为我们需要将appId、timestamp、nonceStr和signature返回给前端，其实appId、timestamp、nonceStr都比较好活动，appId就是公众号的appid，timestamp就是当前的时间戳，nonceStr则是随机生成的字符串</p>
<p>nonceStr如何获得可以看WeixinPay类中的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@property</div><div class="line">def nonce_str(self):</div><div class="line">    char = string.ascii_letters + string.digits</div><div class="line">    return &quot;&quot;.join(random.choice(char) for _ in range(32))</div></pre></td></tr></table></figure>
<p>它通过@property将nonce_str方法转变成WeixinPay类中的属性</p>
<p>接着看到WeixinPay类中的sign()签名方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">def sign(self, raw):</div><div class="line">    raw = [(k, str(raw[k]) if isinstance(raw[k], int) else raw[k])</div><div class="line">            for k in sorted(raw.keys())]</div><div class="line">    s = &quot;&amp;&quot;.join(&quot;=&quot;.join(kv) for kv in raw if kv[1])</div><div class="line">    s += &quot;&amp;key=&#123;0&#125;&quot;.format(self.mch_key)</div><div class="line">    return hashlib.md5(s.encode(&quot;utf-8&quot;)).hexdigest().upper()</div></pre></td></tr></table></figure>
<p>其实这个签名方法不满足微信对signature签名规则的要求，该签名方法是针对微信支付签名的，而不是jssdk授权签名，<strong>两者主要的区别在于jssdk授权签名不需要商户支付密码而且加密方式是sha1加密</strong>，所以这里需要自己实现一个针对jssdk授权签名的方法，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">def signatureSign(self, raw):</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    获得jssdk授信所需要的signature</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    raw = [(k, str(raw[k]) if isinstance(raw[k], int) else raw[k])</div><div class="line">               for k in sorted(raw.keys())]</div><div class="line">    s = &quot;&amp;&quot;.join(&quot;=&quot;.join(kv) for kv in raw if kv[1])</div><div class="line"></div><div class="line">    signature = hashlib.sha1(s.encode(&apos;utf-8&apos;)).hexdigest().lower()</div><div class="line">    return signature</div><div class="line">```   </div><div class="line"></div><div class="line">这样就有了前端jssdk授权所需要的所有数据，整体代码如下</div></pre></td></tr></table></figure>
<p>class GetJSSDKConfigView(APIView):<br>    ‘’’<br>    返回jssdk授权信息，前端只有获得jssdk授权信息后，才能通过微信的接口获得jssdk的使用权限，有了权限才可以调用微信支付<br>    ‘’’<br>    from extra_apps.weixin import Weixin<br>    import time</p>
<pre><code>weixin = Weixin(
    dict(WEIXIN_APP_ID=微信公众号APPID, WEIXIN_MCH_ID=&apos;微信商户ID，纯数字&apos;, WEIXIN_MCH_KEY=&apos;微信商户KEY&apos;,WEIXIN_NOTIFY_URL=&apos;回调URL&apos;, WEIXIN_MCH_KEY_FILE=&apos;&apos;, WEIXIN_MCH_CERT_FILE=&apos;&apos;))
timestamp = str(int(time.time()))
permission_classes = (IsAuthenticated, IsOwnerOrReadOnly)
authentication_classes = (JSONWebTokenAuthentication, SessionAuthentication)

def signatureSign(self, raw):
    &apos;&apos;&apos;
    获得jssdk授信所需要的signature
    &apos;&apos;&apos;
    raw = [(k, str(raw[k]) if isinstance(raw[k], int) else raw[k])
           for k in sorted(raw.keys())]
    s = &quot;&amp;&quot;.join(&quot;=&quot;.join(kv) for kv in raw if kv[1])

    signature = hashlib.sha1(s.encode(&apos;utf-8&apos;)).hexdigest().lower()
    return signature

def get(self, request, *args, **kwargs):
    if self.request.user:
        data = request._request.GET
        from urllib import parse
        URL = data.get(&apos;URL&apos;, &apos;&apos;)
        URL = parse.unquote(URL)
        try:
            k = WeiXinAccessTokenModel.objects.filter(id=1)[0]
            # 前一小时
            if k.change_time &gt;= datetime.now() - timedelta(hours=2):
                accesstoken = k.accesstoken
            else:
                accesstoken = getAccessToken()
        except:
            accesstoken = getAccessToken()

        # 有效jsapi_ticket
        ticket = getJsapi_ticket(accesstoken)

        # 随机字符串
        nonce_str = self.weixin.nonce_str
        signature = self.signatureSign(dict(noncestr=nonce_str,jsapi_ticket=ticket,timestamp=self.timestamp,url=URL))
        raw = dict(appId=APPID,timestamp=self.timestamp,nonceStr=nonce_str,signature=signature)
        return Response(raw, status=status.HTTP_201_CREATED)
    else:
        return Response({&apos;error&apos;:&apos;用户未登录&apos;}, status=status.HTTP_400_BAD_REQUEST)
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">这里是典型的Django REST Framework的写法，重写了它的get方法，access_token从数据库中取，jsapi_ticket有点偷懒，直接获取了，其他的都是前面讲了的逻辑</div><div class="line"></div><div class="line"></div><div class="line">前端获得了这些内容后，将它和需要申请的权限传给微信服务器，如果第一大步的配置都做了，就可以获得jssdk授权了</div><div class="line"></div><div class="line">## JSSDK调用微信支付</div><div class="line">JSSDK有了权限后就可以调用微信支付了，调用的方法也在微信JS-SDK说明文档中</div></pre></td></tr></table></figure>
<p>wx.chooseWXPay({<br>timestamp: 0, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符<br>nonceStr: ‘’, // 支付签名随机串，不长于 32 位<br>package: ‘’, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）<br>signType: ‘’, // 签名方式，默认为’SHA1’，使用新版支付需传入’MD5’<br>paySign: ‘’, // 支付签名<br>success: function (res) {<br>// 支付成功后的回调函数<br>}<br>});<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">从这里可以看出前端需要timestamp、nonceStr、package、singType和paySign</div><div class="line"></div><div class="line">其中package和paySign的获得需要写点代码，但是使用lweixin-python库后，一行代码就可以获得这些信息了，如下</div></pre></td></tr></table></figure></p>
<p>jsdict = self.weixin.jsapi(out_trade_no=order, body=’微信支付测试’, total_fee=1, trade_type=’JSAPI’,spbill_create_ip=ip,openid=openid)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">你需要做的不过是传入你系统的订单号、用户端的IP和用户的openid</div><div class="line"></div><div class="line">这里我遇到的一个坑就是所谓的用户端IP，如果你是微信公众号支付，这里的IP就要获得用户手机的IP，这个IP是用户的IP不是你服务器的IP，而openid则是该用户对应你微信公众号唯一的ID，这个有多种方式可以获得，这里我们使用了静默授权的方式，后面有机会会讲讲所谓的静默授权，这里就不展示相关的代码</div><div class="line"></div><div class="line">那么将这些内容传递进去就可以了，其实并不玄妙，看都jsapi()方法的代码</div></pre></td></tr></table></figure></p>
<pre><code>def jsapi(self, **kwargs):
    &quot;&quot;&quot;
    生成给JavaScript调用的数据
    详细规则参考 https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7&amp;index=6
    &quot;&quot;&quot;
    kwargs.setdefault(&quot;trade_type&quot;, &quot;JSAPI&quot;)
    raw = self.unified_order(**kwargs)
    package = &quot;prepay_id={0}&quot;.format(raw[&quot;prepay_id&quot;])
    timestamp = str(int(time.time()))
    nonce_str = self.nonce_str
    raw = dict(appId=self.app_id, timeStamp=timestamp,
               nonceStr=nonce_str, package=package, signType=&quot;MD5&quot;)
    sign = self.sign(raw)
    return dict(package=package, appId=self.app_id,
                timeStamp=timestamp, nonceStr=nonce_str, sign=sign)
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">其中通过unified_order()方法调用了微信的统一下单接口从而获得prepay_id，通过这个就可以组成我们需要的package，然后有调用了sign()方法，对appid、timeStamp、nonceStr、package和signType进行签名，获得我们需要的paySign</div><div class="line"></div><div class="line">sign()方法前面已经看过了，这里来看看unified_order()方法</div></pre></td></tr></table></figure>
<pre><code>def unified_order(self, **data):
    &quot;&quot;&quot;
    统一下单
    out_trade_no、body、total_fee、trade_type必填
    app_id, mchid, nonce_str自动填写
    spbill_create_ip 在flask框架下可以自动填写, 非flask框架需要主动传入此参数
    &quot;&quot;&quot;
    url = &quot;https://api.mch.weixin.qq.com/pay/unifiedorder&quot;

    # 必填参数
    if &quot;out_trade_no&quot; not in data:
        raise WeixinPayError(&quot;缺少统一支付接口必填参数out_trade_no&quot;)
    if &quot;body&quot; not in data:
        raise WeixinPayError(&quot;缺少统一支付接口必填参数body&quot;)
    if &quot;total_fee&quot; not in data:
        raise WeixinPayError(&quot;缺少统一支付接口必填参数total_fee&quot;)
    if &quot;trade_type&quot; not in data:
        raise WeixinPayError(&quot;缺少统一支付接口必填参数trade_type&quot;)

    # 关联参数
    if data[&quot;trade_type&quot;] == &quot;JSAPI&quot; and &quot;openid&quot; not in data:
        raise WeixinPayError(&quot;trade_type为JSAPI时，openid为必填参数&quot;)
    if data[&quot;trade_type&quot;] == &quot;NATIVE&quot; and &quot;product_id&quot; not in data:
        raise WeixinPayError(&quot;trade_type为NATIVE时，product_id为必填参数&quot;)
    data.setdefault(&quot;notify_url&quot;, self.notify_url)
    data.setdefault(&quot;spbill_create_ip&quot;, self.remote_addr)

    raw = self._fetch(url, data)
    return raw       
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">看到该方法，其实就是简单将所需要的数据放到data方法中，如果没有需要的数据就给你返回个错误</div><div class="line"></div><div class="line">最终调用_fetch()方法，该方法才是真正去请求微信统一支付接口的方法，看到这个方法我的疑惑就解开了，因为微信支付文档中对于调用统一支付接口需要很多参数，但是我调用jsapi()方法时只穿了少数几个，其他的参数呢？原来直接通过Weixin这个类的实例来获得</div></pre></td></tr></table></figure>
<pre><code>def _fetch(self, url, data, use_cert=False):
    data.setdefault(&quot;appid&quot;, self.app_id)
    data.setdefault(&quot;mch_id&quot;, self.mch_id)
    data.setdefault(&quot;nonce_str&quot;, self.nonce_str)
    data.setdefault(&quot;sign&quot;, self.sign(data))

    if use_cert:
        resp = self.sess.post(url, data=self.to_xml(data), cert=(self.cert, self.key))
    else:
        resp = self.sess.post(url, data=self.to_xml(data))
    content = resp.content.decode(&quot;utf-8&quot;)
    if &quot;return_code&quot; in content:
        data = Map(self.to_dict(content))
        if data.return_code == FAIL:
            raise WeixinPayError(data.return_msg)
        if &quot;result_code&quot; in content and data.result_code == FAIL:
            raise WeixinPayError(data.err_code_des)
        return data
    return content
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">那么到这里相信你也通透了，看一下完整代码</div><div class="line"></div><div class="line">```python</div><div class="line">class WeiPayView(APIView):</div><div class="line">    permission_classes = (IsAuthenticated, IsOwnerOrReadOnly)</div><div class="line">    authentication_classes = (JSONWebTokenAuthentication, SessionAuthentication)</div><div class="line"></div><div class="line"></div><div class="line">    from extra_apps.weixin import Weixin, WeixinError</div><div class="line">    from wk.settings import APPID</div><div class="line"></div><div class="line">    weixin = Weixin(</div><div class="line">        dict(WEIXIN_APP_ID=微信公众号APPID, WEIXIN_MCH_ID=&apos;微信商户ID，纯数字&apos;, WEIXIN_MCH_KEY=&apos;微信商户KEY&apos;,WEIXIN_NOTIFY_URL=&apos;回调URL&apos;, WEIXIN_MCH_KEY_FILE=&apos;&apos;, WEIXIN_MCH_CERT_FILE=&apos;&apos;))</div><div class="line"></div><div class="line">    def get(self, request, *args, **kwargs):</div><div class="line">        &apos;&apos;&apos;</div><div class="line">        调用微信支付，返回前端数据，让前端使用jssdk来使用微信支付</div><div class="line">        前端传递订单号，通过订单号调用微信接口</div><div class="line">        &apos;&apos;&apos;</div><div class="line">        data = request._request.GET</div><div class="line">        # 订单号</div><div class="line">        order = str(data.get(&apos;order&apos;, &apos;&apos;))</div><div class="line"></div><div class="line">        # order_sn = OrderInfo.objects.all()[0].order_sn</div><div class="line">        openid = self.request.user.openid</div><div class="line">        ip = request._request.META[&apos;REMOTE_ADDR&apos;]</div><div class="line">        # 需要给前端返回的内容，out_trade_no订单号，total_fee是金额*100，trade_type调用微信支付的方式，spbill_create_ip用户端的IP，需要配置</div><div class="line">        jsdict = self.weixin.jsapi(out_trade_no=order, body=&apos;微信支付测试&apos;, total_fee=1, trade_type=&apos;JSAPI&apos;,spbill_create_ip=ip,openid=openid)</div><div class="line">        return Response(jsdict, status=status.HTTP_201_CREATED)</div></pre></td></tr></table></figure>
<p>需要提一下，实例化Weixin类时传入的WEIXIN_NOTIFY_URL，除了可以是URL外，还可以是IP，这个IP后可以加上相应的端口，比如8.8.8.8:9000/callback，这个路径用于接受微信服务器的回调，无用支付成功或失败</p>
<p>前端获取这些信息后，按微信提供的格式传递给微信服务器就可以调用微信支付了，这里需要注意，<strong>前端传值的字段名要严格按照微信提供的来，比如微信要appId，你不能穿appid，微信要nonceStr，你不能noncestr</strong>，被前端坑了一下午，一直以为配置错了，当时咋没将自己99级的杀猪大刀带来上班呢？</p>
<h2 id="微信回调"><a href="#微信回调" class="headerlink" title="微信回调"></a>微信回调</h2><p>虽然微信支付调用成功了，但是还有个很多的逻辑就是微信回调，前端的回调比较简单，就是跳转一下页面，提醒一下用户，这里说一个坑，因为我们前端使用的是AngelarJS，一般AngelarJS通过路由的方式来跳转界面，但是微信回调会带上一些信息，此时通过AngelarJS的路由进行页面跳转的话，很可能就会造成页面混乱的问题，解决方法也很多简单，就会通过原生的js跳转就好了</p>
<p>微信回调的主要逻辑其实在后端，比如用户购买成功了，微信系统就会通过你配置的回调接口将用户支付的行为返回，那么这里其实涉及到了一个安全问题，微信文档中是没有提回调的，网上一查，如何验证微信的回调信息？有人直接通过返回来的nonceStr与此前传过去的nonceStr做对比，如果相同，那么就认为没问题</p>
<p>虽然nonceStr是随机生成的，但是根本不能保证安全性，如果你无法保证是微信返回的消息，那么很容易就被hack攻击，攻击过程也很简单，使用你的产品，设置代理进行抓包，抓到你发送给微信的信息和微信返回给你的信息，此时hack就知道微信返回的数据格式了，下次购买时，同样抓包，获得你发送给微信的信息，从中获取此次发送给微信的nonceStr，构造虚假的微信返回数据格式，将nonceStr放到虚假的格式中，通过发包软件发送给你的系统，那么你的系统就会判断用户支付成功，实际上hack一分钱没付，如果你是商城，那么分分钟被人撸光所有的货品</p>
<p>那要怎么做才能保证安全呢？很简单，就是对数据进行再次签名，签名中使用了微信商户的KEY，这个除了自己和微信系统其它人都是不知道的，通过微信商户KEY对微信返回回调接口的数据进行签名后，在于回调数据中的前面数据进行对比，如果相同，那么可以认为数据没有被修改，可以正常使用，当然这不能保证数据是微信服务器发送过来的，因为第三者可以保留这份数据，再对你进行发送，当然这份数据第三者不能进行修改，所以对我们系统来说，其实没有什么差，这个过程可以使用WeixinPay类中的check()方法，帮我们完成了验证微信回传数据是否可靠的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">from django.http.response import HttpResponse, HttpResponseBadRequest</div><div class="line">from django.views.decorators.csrf import csrf_exempt</div><div class="line"></div><div class="line"></div><div class="line">@csrf_exempt</div><div class="line">def WeiPayCallBackView(request):</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    因为Django Rest Framework不支持text/xml形式的xml，要么修改drf的源代码，要么通过原始的Django方法来响应</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    if request.method == &apos;POST&apos;:</div><div class="line">        from extra_apps.weixin import Weixin, WeixinError</div><div class="line">        from wk.settings import APPID</div><div class="line">        weixin = Weixin(</div><div class="line">        dict(WEIXIN_APP_ID=微信公众号APPID, WEIXIN_MCH_ID=&apos;微信商户ID，纯数字&apos;, WEIXIN_MCH_KEY=&apos;微信商户KEY&apos;,WEIXIN_NOTIFY_URL=&apos;回调URL&apos;, WEIXIN_MCH_KEY_FILE=&apos;&apos;, WEIXIN_MCH_CERT_FILE=&apos;&apos;))</div><div class="line"></div><div class="line">        data = weixin.to_dict(request.body)</div><div class="line">        order_sn = data.get(&apos;out_trade_no&apos;,&apos;&apos;)</div><div class="line">        # 支付结果，用户正常支付，会返回SUCCESS</div><div class="line">        result_code = data.get(&apos;result_code&apos;,&apos;&apos;)</div><div class="line">        # check 检查微信回传数据是否可靠</div><div class="line">        if not weixin.check(data):</div><div class="line">            return HttpResponse(weixin.reply(&quot;签名验证失败&quot;, False))</div><div class="line"></div><div class="line">        try:</div><div class="line">            pay_status = OrderInfo.objects.filter(order_sn=order_sn)[0].pay_status</div><div class="line">            </div><div class="line">            if pay_status == &apos;paying&apos; and result_code == &apos;SUCCESS&apos;:</div><div class="line">                </div><div class="line">              &apos;&apos;&apos;</div><div class="line">              用户支付成功后，你系统要做的具体逻辑</div><div class="line">              &apos;&apos;&apos;</div><div class="line">            return HttpResponse(weixin.reply(&quot;OK&quot;, True), content_type=&apos;text/xml&apos;)</div><div class="line">        except:</div><div class="line">            return HttpResponse(weixin.reply(&quot;签名验证失败&quot;, False), content_type=&apos;text/xml&apos;)</div></pre></td></tr></table></figure>
<p>代码逻辑比较简单，这样我也遇到了几个坑，因为整个项目采用的是前后端分离开发，后端使用的是Django REST Framework，因为微信回传的数据是xml格式的，而且Content-Type是text/xml，Django REST Framework中不支持text/xml这种格式，解决方法有多种，一种是修改Django REST Framework的源代码，不推荐，另一种就直接用原生的Django来写，因为原生的Django默认需要进行csrf_exempt验证，微信时不可能给你返回csrf_exempt信息的，所以要去除Django默认的验证，非常简单，在这个接口上加上@csrf_exempt就可以了</p>
<p>接着要注意的是我们回传给微信系统的数据也要是Content-Type为text/xml的，然后又是一个坑，无论你是否返回数据给微信系统响应这次回调，微信为了保证你能收到回传的数据，都会多次回调你这个接口，如果你在逻辑上不做处理，你的逻辑就会执行多遍，我的做法是先获得系统中对于订单的状态，如果订单是未支付的状态，那么就执行相应的逻辑，如果订单已经完成支付，就直接跳过这些逻辑，返回一个OK信息给微信支付系统</p>
<p>当然，微信无论用户支付成功、支付失败还是取消支付都会通过回调接口返回信息，所以要对微信返回信息的状态做一个判断，如果是SUCCESS，说明用户支付成功了，只有这个使用才执行自己支付成功的逻辑</p>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>到这里微信支付才算完整的弄完了，回头一看，感觉还是挺简单的，这里就牵扯出一个有趣的现象，当一个人掌握了一个东西后就会觉得简单，从而忘记了掌握这个东西的过程中的困难，当其他人问你的时候，你就会给它造成认知偏差，说，这东西非常简单，几天就可以精通了，这个在编程圈屡见不鲜。</p>
<p>微信支付坑多吗？不会啊，就配置一下，写点代码就好，这有什么坑的，非常简单，1个小时应该就可以搞定了，哈哈哈。</p>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2018/06/17/python程序运行原理/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/05/14/python变量和数据类型/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="ayuLiao's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        myemailliao@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="myemailliao@gmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/06/">六月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/05/">五月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/04/">四月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/03/">三月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/02/">二月 2018<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/09/">九月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/07/">七月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/06/">六月 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/09/">九月 2016<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/08/">八月 2016<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/07/">七月 2016<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/06/">六月 2016<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/05/">五月 2016<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/tags" title="标签">
                
                    <i class="material-icons sidebar-material-icons">label</i>
                
                标签
            </a>
        </li>
        
    
        <li>
            <a href="/timeline" title="时间轴">
                
                    <i class="material-icons sidebar-material-icons">timeline</i>
                
                时间轴
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://www.github.com/ayuliao" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;2016&nbsp;-<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>ayuLiao
            <div>
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <div>
        本站总访问量 <span id="busuanzi_value_site_pv"></span> &nbsp&nbsp&nbsp
        你是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴
        </div>
        </div>
        </div>

        <!-- Paradox Footer Right Section -->

        

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?wgjW/HuQG9JDgvPDPoRAng==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>



    
        <script>lsloader.load("js/smoothscroll.js","/js/smoothscroll.js?tNQK2Tw2SUL8a1Scn/Mgew==")</script>
    











<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
        </body>
    
</html>
